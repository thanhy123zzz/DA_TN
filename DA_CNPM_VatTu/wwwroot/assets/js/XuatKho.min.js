function loadTable(){$.ajax({type:"POST",url:"/QuanLy/XuatKho/api/hhs"}).done(function(n){$("#tBodyCtpx").append(getRowPhieuXuatCt());configRowPhieuXuatCt($("#tBodyCtpx tr:last"),n);$("#hangHoaLS").selectize({maxOptions:50,valueField:"id",labelField:"ten",searchField:["ten","ma"],placeholder:"-- Hàng hoá --",loadThrottle:400,options:n,render:{option:function(n){return`<div class="px-2 py-1"><b>[${n.ma}]</b> - ${n.ten}</div>`},no_results:function(){return'<div class="no-results">Không tìm thấy dữ liệu <\/div>'}}})})}function xoaTrangPhieuXuatKho(){$.ajax({type:"post",url:"/QuanLy/XuatKho/api/getSoPhieuXuat",success:function(n){$("#inputText").val(n)},error:function(){alert("Fail")}});$("#KhachHang")[0].selectize.clear();$("#NgayXuat").val(getDateTimeNow());$("#ngayHD").val(getDateNow());$("#soHD").val("");$("#ghiChu").val("");$("#tBodyCtpx tr").each(function(){var n=$(this);n.find("select").each(function(){this.selectize&&this.selectize.destroy()})});$("#tBodyCtpx").empty();loadTable()}function getRowPhieuXuatCt(){return`<tr>
        <td><select class="form-select form-table" name="Idhh" style="width: 300px;"></select></td>
        <td class="text-center"><img class='image-modal object-fit-cover' style="max-height: 32px;max-width: 42px;border-radius:0;" src="" alt=''></td>
        <td><select class="form-select form-table" name="Iddvt" style="width: 140px;"></select></td>
        <td><input autocomplete="off" class="form-control form-table input-number-float" name="Sl" style="min-width: 80px;"/></td>
        <td><input class="form-control form-table slqd input-number-float" readonly style="min-width: 42px;"/></td>
        <td><input autocomplete="off" class="form-control form-table input-number-float" name="DonGia" readonly style="min-width: 120px;"/></td>
        <td><input autocomplete="off" class="form-control form-table ThanhTien input-number-float" readonly style="min-width: 140px;"/></td>
        <td><input autocomplete="off" class="form-control form-table input-number-float" name="Cktm" max="100" style="min-width: 60px;"/></td>
        <td><input autocomplete="off" class="form-control form-table input-number-float" name="Thue" max="100" style="min-width: 60px;"/></td>
        <td class='last-td-column'>
            <div class="action justify-content-center">
                <button class="text-danger btn-remove-ct">
                    <i class="lni lni-trash-can"></i>
                </button>
            </div>
        </td>
    </tr>`}function configRowPhieuXuatCt(n,t){var i=n.find('select[name="Idhh"]');i.selectize({maxOptions:50,valueField:"id",labelField:"ten",searchField:["ten","ma"],placeholder:"-- Hàng hoá --",options:t,loadThrottle:400,dropdownParent:"#dropdow-show",closeAfterSelect:0,allowEmptyOption:!1,onDropdownOpen:function(n){showDropdownMenu(i,n)},onChange:function(n){dropDownHhChange(i,n)},onFocus:function(){$(".my-selectize-2").not(this.$input).each(function(){this.selectize&&(this.selectize.close(),this.selectize.blur())})},render:{option:function(n){return`<div class="px-2 py-1">
                            <div class="d-flex justify-content-between">
                                <div class="col-auto">
                                    <b>[${n.ma}]</b>
                                </div>
                                <div class="col-auto text-end">
                                ${n.ten}
                                </div>
                           </div>
                           <div>
                                Số lượng còn: <span class="${n.slTon<1?"text-danger":""}">${n.slTon}</span> - Ngăn kệ: ${n.nganKe}
                           </div>
                        </div>`},no_results:function(){return'<div class="no-results">Không tìm thấy dữ liệu <\/div>'}}})}function dropDownHhChange(n,t){var i=n.closest("tr"),e=n[0].selectize,f,r,u;if(e&&t){if(f=Object.values(e.options),r=f.find(function(n){return n.id==t}),r.slTon==0){showToast("Đã hết hàng trong kho!",500);n[0].selectize.clear();i.find("img.image-modal").prop("src","");i.find("img.image-modal").prop("alt","");i.find('select[name="Iddvt"]')[0].selectize.destroy();i.find('input[name="Sl"]').prop("max",0);i.find('input[name="Sl"]').val("");i.find(".slqd").val("");i.find('input[name="DonGia"]').val("");i.find('input[name="Cktm"]').val("");i.find('input[name="Thue"]').val("");i.find("input.ThanhTien").val("");return}i.find("img.image-modal").prop("alt",r.ten);r.hinh?i.find("img.image-modal").prop("src",r.hinh):i.find("img.image-modal").prop("src","");i.find('input[name="Sl"]').prop("max",r.slTon);i.find(".slqd").val(1);formatNumberFloatWithElement(i.find(".input-number-float"));r.dvts.unshift(r.dvtChinh);u=i.find('select[name="Iddvt"]');loadDonGia(t,r.dvtChinh.id,$("#KhachHang").val(),i.find('input[name="DonGia"]'));u[0].selectize?(u[0].selectize.clear(),u[0].selectize.clearOptions(),u[0].selectize.addOption(r.dvts),u[0].selectize.setValue(r.dvtChinh.id)):u.selectize({placeholder:"-- Đơn vị tính --",options:r.dvts,valueField:"id",labelField:"ten",searchField:["ten","ma"],dropdownParent:"#dropdow-show",closeAfterSelect:0,items:[r.dvtChinh.id],onDropdownOpen:function(n){showDropdownMenu(u,n)},onChange:function(n){var t,o;if(n){var r=i.find('select[name="Idhh"]'),f=r.val(),e=u[0].selectize.options[n].slqd;i.find("input.slqd").val(e);t=i.find('input[name="Sl"]');o=r[0].selectize.options[f].slTon;t.val(0);t.prop("max",o/e);formatNumberFloatWithElement(t);loadDonGia(f,n,$("#KhachHang").val(),i.find('input[name="DonGia"]'))}},onFocus:function(){$(".my-selectize-2").not(this.$input).each(function(){this.selectize&&(this.selectize.close(),this.selectize.blur())})}});i.is(":last-child")&&($("#tBodyCtpx").append(getRowPhieuXuatCt()),configRowPhieuXuatCt($("#tBodyCtpx tr:last"),f))}}function loadDonGia(n,t,i,r){i&&n&&t&&$.ajax({type:"post",url:"/QuanLy/XuatKho/load-tthh",data:{idKh:i,idHh:n,idDvt:t},success:function(n){r.val(n).trigger("keyup")},error:function(n){console.log(n)}})}function updateGiaTongTien(){var n=0,t=0,i=0;$("#tBodyCtpx tr").each(function(){var f=$(this),r=parseFloat(f.find("input.ThanhTien").inputmask("unmaskedvalue")),e,u,o,s;r&&(n+=parseFloat(r));e=parseFloat(f.find('input[name="Cktm"]').inputmask("unmaskedvalue"));u=0;e&&r&&(u=e*r/100,t+=u);o=parseFloat(f.find('input[name="Thue"]').inputmask("unmaskedvalue"));s=0;o&&r&&(s=(r-u)*o/100,i+=s)});$("#TienHang").val(n);$("#TienCK").val(t);$("#TienThue").val(i);$("#TienThanhToan").val(n-t+i)}function cancelXemPhieu(){$("#tabXemPhieu").addClass("d-lg-none");$("#bordered-justified-profile").addClass("active");$("#bordered-justified-profile").addClass("show")}function offTabNhap(){$("#tabXemPhieu").addClass("d-none")}$(document).ready(function(){var n=[{el:$("#KhachHangLS"),placeholder:"-- Khách hàng --",url:"/QuanLy/XuatKho/api/khs"}];configCb(n);configDate();configDateTime();formatNumberFloatWithElement($(".input-number-float"));loadTable();$(document).on("click",".btn-remove-ct",function(){var n=$(this).closest("tr"),t=n.find('input[name="Id"]').val();t&&_daXoa.push(parseInt(t));n.is(":last-child")||(n.find("select").each(function(){this.selectize&&this.selectize.destroy()}),n.remove(),updateGiaTongTien())});$.ajax({url:"/QuanLy/XuatKho/api/khs",method:"POST"}).done(function(n){$("#KhachHang").selectize({maxOptions:50,valueField:"id",labelField:"ten",searchField:["ten","ma"],placeholder:"-- Khách hàng --",loadThrottle:400,options:n,onChange:function(n){$("#tBodyCtpx tr").each(function(){var t=$(this),i=t.find('select[name="Idhh"]').val();i&&loadDonGia(i,t.find('select[name="Iddvt"]').val(),n,t.find('input[name="DonGia"]'))})},render:{item:function(n,t){return"<div>"+t(n.ten+" ("+n.loai+")")+"<\/div>"},option:function(n){return`<div class="px-2 py-1"><b>${n.ten}</b> - [${n.loai}]</div>`}}})});$(document).on("keyup",'input[name="Sl"]',function(){var n=$(this).closest("tr"),i=parseFloat($(this).inputmask("unmaskedvalue")),t=parseFloat(n.find('input[name="DonGia"]').inputmask("unmaskedvalue"));t!=""&&(n.find("input.ThanhTien").val(i*t),updateGiaTongTien())});$(document).on("keyup",'input[name="DonGia"]',function(){var n=$(this).closest("tr"),i=parseFloat($(this).inputmask("unmaskedvalue")),t=parseFloat(n.find('input[name="Sl"]').inputmask("unmaskedvalue"));t!=""&&(n.find("input.ThanhTien").val(t*i),updateGiaTongTien())});$(document).on("keyup",'input[name="Cktm"], input[name="Thue"]',function(){updateGiaTongTien()});$("#btnTaoPhieu").on("click",function(){var i=document.getElementById("formTaoPhieuXuat"),n,t,r;if(i.checkValidity()){if(!$("#KhachHang").val()||!$("#NgayXuat").val()){$("#nhaCC").val()?showToast("Chưa nhập ngày xuất!",500):showToast("Chưa chọn khách hàng!",500);return}spinnerBtn($("#btnTaoPhieu"));n=[];t=!0;$("#tBodyCtpx tr").each(function(){var i=$(this),u=i.find('select[name="Idhh"]').val(),r,e,o,f;console.log(u);r=i.find('input[name="Sl"]').inputmask("unmaskedvalue");u?(i.removeClass("bg-danger"),e=i.find('input[name="Cktm"]').inputmask("unmaskedvalue"),o=i.find('input[name="Thue"]').inputmask("unmaskedvalue"),r?(i.find('input[name="Sl"]').closest("td").removeClass("bg-danger"),f=getDataFromTr(i),n.push(f)):(r||i.find('input[name="Sl"]').closest("td").addClass("bg-danger"),t=!1,showBtn($("#btnTaoPhieu"),"Tạo phiếu"))):i.is(":last-child")||i.addClass("bg-danger")});n.length==0&&(t=!1);t?(r={Idkh:$("#KhachHang").val(),SoHd:$("#soHD").val(),NgayTao:$("#NgayXuat").val(),NgayHd:$("#ngayHD").val(),GhiChu:$("#ghiChu").val(),ChiTietPhieuXuatMaps:n},$.ajax({type:"post",url:"/QuanLy/XuatKho/add-px",data:JSON.stringify(r),contentType:"application/json",success:function(n){showToast(n.message,n.statusCode);n.statusCode==200&&(showBtn($("#btnTaoPhieu"),"Tạo phiếu"),xoaTrangPhieuXuatKho(),$("#btnLoadLsXuat").click())},error:function(n){console.log(n);showBtn($("#btnTaoPhieu"),"Tạo phiếu")}})):showBtn($("#btnTaoPhieu"),"Tạo phiếu")}else i.classList.add("was-validated")});$("#btnXoaTrang").on("click",function(){xoaTrangPhieuXuatKho()});$("#btnLoadLsXuat").on("click",function(){showLoader($("#LichSuXuat"));var n=$("#toDay").val(),t=$("#fromDay").val(),i=$("#KhachHangLS").val(),r=$("#hangHoaLS").val(),u=$("#soPhieuLS").val(),f=$("#soHDLS").val();$.ajax({type:"post",url:"/QuanLy/XuatKho/loadTableLichSuXuat",data:"toDay="+n+"&fromDay="+t+"&KhLs="+i+"&hhLS="+r+"&soPhieuLS="+u+"&soHDLS="+f,success:function(n){hideLoader();$("#tBodyLSXuat").empty();$("#tBodyLSXuat").append(n)},error:function(){alert("Fail")}})});$(document).on("click",".btn-view-pn",function(){$("#bordered-justified-profile").removeClass("active");$("#bordered-justified-profile").removeClass("show");$("#tabXemPhieu").removeClass("d-lg-none");var n=$(this).val();$.ajax({type:"post",url:"/QuanLy/XuatKho/ViewThongTinPhieuXuat",data:"idPX="+n,success:function(n){$("#tabXemPhieu").replaceWith(n)},error:function(){alert("Fail")}})})});